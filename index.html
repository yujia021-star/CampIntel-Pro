async function diagnose() {
    document.getElementById('loader').style.display = 'flex';
    try {
        const loc = document.getElementById('loc').value;
        const res = await fetch(`${gasUrl}?mode=diagnose&place=${encodeURIComponent(loc)}`);
        const data = await res.json();
        
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('resLoc').innerText = data.locationName;
        document.getElementById('resScore').innerText = data.score;
        document.getElementById('resReason').innerText = `(${data.scoreReason})`; // ã‚¹ã‚³ã‚¢è§£èª¬ã‚’è¡¨ç¤º
        updateGauge(data.score);

        let html = "";
        
        // 1. ã€æœ€å„ªå…ˆã€‘æœ€æ–°ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»é‡å¤§ãƒªã‚¹ã‚¯ (èµ¤æ )
        if (data.criticalAlerts && data.criticalAlerts.length > 0) {
            html += `<div style="border: 2px solid #ff4444; background: rgba(255,0,0,0.1); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                        <h4 style="color:#ff4444; margin:0 0 10px 0; font-size:0.9rem;">âš ï¸ ç›´è¿‘ã®ãƒªã‚¹ã‚¯æƒ…å ±</h4>`;
            data.criticalAlerts.forEach(a => {
                html += `<div style="font-size:0.8rem; margin-bottom:8px; color:white;">
                            <b>[${a.category}]</b> ${a.content} ${a.severity}
                         </div>`;
            });
            html += `</div>`;
        }

        // 2. ã€æ—¥è¨˜ã‹ã‚‰æŠ½å‡ºã€‘å…ˆäººã®çŸ¥æµ (é’æ )
        if (data.localInsights && data.localInsights.length > 0) {
            html += `<div class="tag">ğŸ“” å…ˆäººãŸã¡ã®è¦æ³¨æ„å ±å‘Š</div>`;
            data.localInsights.forEach(i => {
                html += `<div class="insight-box" style="background:rgba(0,150,255,0.1); margin-bottom:10px; border:1px solid rgba(0,150,255,0.3);">
                            <div style="font-size:0.85rem;">ã€Œ${i.content}ã€</div>
                         </div>`;
            });
        }

        // 3. æ¨å¥¨è£…å‚™
        html += `<div class="tag">ğŸ›¡ï¸ æ¨å¥¨è£…å‚™</div>
                 <div class="insight-box" style="background:rgba(255,255,255,0.05);">
                    ${data.score > 40 ? "<div>âœ… é›é€ ãƒšã‚°ãƒ»å†¬ç”¨å¯å…·ã‚’å¼·ãæ¨å¥¨</div>" : "<div>âœ… æ¨™æº–çš„ãªè£…å‚™ã§å¯¾å¿œå¯èƒ½ã§ã™</div>"}
                 </div>`;
        
        document.getElementById('insightContainer').innerHTML = html;
        document.getElementById('resTimeline').innerHTML = data.timeline.map(t => `<div class="t-item"><div style="font-size:0.6rem; color:var(--accent);">${t.time}</div><img src="https://openweathermap.org/img/wn/${t.icon}.png" width="30"><div>${t.temp}â„ƒ</div></div>`).join('');
        
    } catch(e) { alert("è¨ºæ–­ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    document.getElementById('loader').style.display = 'none';
}
