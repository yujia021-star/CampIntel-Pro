<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampGuard Expert v9.1</title>
    <style>
        :root { --bg: #0b0f1a; --accent: #00d4ff; --card: rgba(23, 32, 53, 0.95); --text: #e0e6ed; --danger: #ff4d4d; --warning: #ffaa00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; line-height: 1.4; }
        .container { max-width: 480px; margin: 0 auto; }
        .main-card { background: var(--card); border-radius: 28px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); text-align: center; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .score { font-size: 5rem; font-weight: 900; line-height: 1; margin: 15px 0; transition: color 0.5s; }
        .ai-recommend { background: rgba(0, 212, 255, 0.1); border-left: 4px solid var(--accent); padding: 15px; border-radius: 12px; text-align: left; font-size: 0.9rem; margin-top: 15px; }
        .insight-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .insight-item { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 12px 0; font-size: 0.85rem; text-align: left; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; background: var(--accent); color: var(--bg); }
        .badge-danger { background: var(--danger); color: white; }
        .search-row { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #1a2236; color: white; outline: none; font-size: 1rem; }
        button { background: var(--accent); color: var(--bg); border: none; padding: 0 20px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        .loading { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader" class="loading">
    <div class="spinner"></div>
    <div>ğŸ§  ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ç…§åˆä¸­...</div>
</div>

<div class="container">
    <h2 style="text-align:center; letter-spacing: 2px; margin: 10px 0;">CAMPGUARD <span style="color:var(--accent)">EXPERT</span></h2>

    <div class="search-row">
        <input type="text" id="locInput" placeholder="ã‚­ãƒ£ãƒ³ãƒ—å ´åã¾ãŸã¯åœ°å" value="å–œå¤šæ–¹å¸‚">
        <button onclick="diagnose()">è¨ºæ–­</button>
    </div>

    <div class="main-card">
        <div style="font-size: 0.75rem; font-weight: bold; color: var(--accent); text-transform: uppercase;">Current Risk Level</div>
        <div id="scoreVal" class="score">--</div>
        
        <div id="recArea" class="ai-recommend" style="display:none;">
            <div style="font-size: 0.7rem; color: var(--accent); font-weight: bold; margin-bottom: 5px;">AI ADVICE</div>
            <div id="recText" style="white-space: pre-wrap;"></div>
        </div>
    </div>

    <div id="insightCard" class="insight-card" style="display:none;">
        <div style="font-weight: bold; color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid rgba(0,212,255,0.3); padding-bottom: 5px;">ğŸ“š éå»ã®é‡è¦çŸ¥è¦‹</div>
        <div id="insightList"></div>
    </div>
</div>

<script>
    // æŒ‡å®šã•ã‚ŒãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec";

    async function diagnose() {
        const loader = document.getElementById('loader');
        const loc = document.getElementById('locInput').value;
        if(!loc) return alert("å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        loader.style.display = 'flex';
        
        try {
            const res = await fetch(`${gasUrl}?place=${encodeURIComponent(loc)}`);
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã¨è‰²ã®å¤‰æ›´
            const scoreEl = document.getElementById('scoreVal');
            scoreEl.innerText = data.score;
            scoreEl.style.color = data.score >= 70 ? 'var(--danger)' : (data.score >= 40 ? 'var(--warning)' : 'var(--accent)');
            
            // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®åæ˜ 
            document.getElementById('recText').innerText = data.recommendation;
            document.getElementById('recArea').style.display = 'block';

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®çŸ¥è¦‹åæ˜ 
            const insightList = document.getElementById('insightList');
            if (data.pastInsights && data.pastInsights.length > 0) {
                insightList.innerHTML = data.pastInsights.map(i => `
                    <div class="insight-item">
                        <span class="badge ${i.importance >= 4 ? 'badge-danger' : ''}">é‡è¦åº¦ ${i.importance}</span>
                        <span style="font-size:0.7rem; color:#8899a6; float:right;">${i.date}</span><br>
                        <strong style="color:var(--accent)">${i.topic}</strong>
                        <div style="color:#cbd5e1; margin-top:5px; font-size:0.8rem;">${i.content}</div>
                    </div>
                `).join('');
                document.getElementById('insightCard').style.display = 'block';
            } else {
                document.getElementById('insightCard').style.display = 'none';
            }
        } catch(e) { 
            console.error(e);
            alert("è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); 
        } finally {
            loader.style.display = 'none';
        }
    }
</script>
</body>
</html>
