<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampIntel Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --warning: #ef4444; --general: #10b981; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        .container { max-width: 480px; margin: 0 auto; padding: 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; } .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Âè≥‰∏äÂõ∫ÂÆö„É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥ */
        .logout-top { 
            position: fixed; top: 15px; right: 15px; z-index: 2000; 
            background: rgba(239, 68, 68, 0.15); color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; 
            padding: 6px 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer;
            backdrop-filter: blur(4px); display: none;
        }

        #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card); width: 100%; max-width: 350px; padding: 30px; border-radius: 28px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .main-card { background: var(--card); border-radius: 28px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08); }
        .gauge-outer { position: relative; height: 160px; margin-bottom: 10px; }
        .score-display { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; }
        .score-num { font-size: 5rem; font-weight: 900; line-height: 1; }
        input, textarea, select { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 12px; outline: none; box-sizing: border-box; font-size: 16px; }
        .btn-primary { background: var(--accent); color: #0f172a; border: none; border-radius: 14px; padding: 14px; font-weight: bold; width: 100%; cursor: pointer; }
        .tag { font-size: 0.75rem; color: var(--accent); font-weight: bold; text-align: left; margin-top: 20px; margin-bottom: 8px; text-transform: uppercase; }
        .insight-box { padding: 16px; border-radius: 20px; font-size: 0.95rem; margin-bottom: 12px; text-align: left; }
        .local-info { border-left: 4px solid var(--warning); background: rgba(239, 68, 68, 0.08); }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.95); display: flex; justify-content: space-around; padding: 15px 0 25px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { cursor: pointer; font-size: 0.65rem; opacity: 0.4; color: white; text-align: center; flex: 1; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .loading { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 4000; }
        .timeline { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
        .t-item { background: #334155; padding: 10px; border-radius: 12px; min-width: 65px; text-align: center; }
    </style>
</head>
<body>

<div id="loader" class="loading">Ëß£Êûê‰∏≠...</div>

<div id="logoutBtn" class="logout-top" onclick="logout()">LOGOUT</div>

<div id="loginOverlay">
    <div class="login-card">
        <h2>CampIntel Pro</h2>
        <input type="text" id="uid" placeholder="„É¶„Éº„Ç∂„ÉºID">
        <input type="password" id="pwd" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
        <button class="btn-primary" onclick="attemptLogin()">„É≠„Ç∞„Ç§„É≥</button>
    </div>
</div>

<div class="container" id="mainApp" style="display:none;">
    <div id="pageDiag" class="page active">
        <h2 style="text-align:center;">CAMPINTEL <span style="color:var(--accent)">PRO</span></h2>
        <div style="display:flex; gap:8px; margin-bottom:20px;">
            <input type="text" id="loc" placeholder="„Ç≠„É£„É≥„ÉóÂ†¥Âêç" style="margin:0;">
            <button class="btn-primary" onclick="diagnose()" style="width:80px; padding:0;">Âà§ÂÆö</button>
        </div>
        <div id="resultArea" style="display:none;">
            <div class="main-card">
                <div id="resLoc" style="font-size:0.9rem; color:var(--accent); font-weight: bold;"></div>
                <div class="gauge-outer">
                    <canvas id="gaugeChart"></canvas>
                    <div class="score-display">
                        <div id="resScore" class="score-num">0</div>
                        <div id="resReason" style="font-size:0.75rem; opacity:0.6;"></div>
                    </div>
                </div>
                <div id="insightContainer"></div>
            </div>
            <div id="resTimeline" class="timeline"></div>
        </div>
    </div>

<div id="pageHazard" class="page">
        <h2 style="text-align:center;">AREA <span style="color:var(--accent)">HAZARD</span></h2>
        <div class="main-card">
            <input type="datetime-local" id="hDate">
            
            <select id="hRegion" onchange="updatePrefectures()">
                <option value="" disabled selected>„Çø„ÉÉ„Éó„Åó„Å¶Âú∞Êñπ„ÇíÈÅ∏Êäû</option>
                <option value="ÂåóÊµ∑ÈÅì">ÂåóÊµ∑ÈÅì</option>
                <option value="Êù±Âåó">Êù±Âåó</option>
                <option value="ÂåóÈñ¢Êù±">ÂåóÈñ¢Êù±</option>
                <option value="ÂçóÈñ¢Êù±">ÂçóÈñ¢Êù±</option>
                <option value="Áî≤‰ø°Ë∂ä">Áî≤‰ø°Ë∂ä</option>
                <option value="ÂåóÈô∏">ÂåóÈô∏</option>
                <option value="Êù±Êµ∑">Êù±Êµ∑</option>
                <option value="ËøëÁïø">ËøëÁïø</option>
                <option value="‰∏≠ÂõΩ">‰∏≠ÂõΩ</option>
                <option value="ÂõõÂõΩ">ÂõõÂõΩ</option>
                <option value="‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ">‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ</option>
            </select>

            <select id="hArea">
                <option value="">‚ÜëÂú∞Êñπ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            </select>

            <button class="btn-primary" onclick="loadHazardMap()">36ÊôÇÈñì„É™„Çπ„ÇØ„Çí„Çπ„Ç≠„É£„É≥</button>
        </div>
        <div id="hazardList"></div>
    </div>

    <div id="pageDiary" class="page">
        <h2 style="text-align:center;">Êó•Ë®ò„ÇíË®òÈå≤</h2>
        <div class="main-card" style="text-align:left;">
            <input type="date" id="dDate">
            <input type="text" id="dPlace" placeholder="üìç „Ç≠„É£„É≥„ÉóÂ†¥Âêç">
            <input type="text" id="dTopic" placeholder="üè∑Ô∏è „Çø„Ç§„Éà„É´">
            <textarea id="dContent" placeholder="ÂÜÖÂÆπ..."></textarea>
            <button class="btn-primary" onclick="saveDiary()">ÁôªÈå≤</button>
        </div>
    </div>

    <div id="pageHistory" class="page">
        <h2 style="text-align:center;">Â±•Ê≠¥</h2>
        <div id="historyList"></div>
    </div>
</div>

<div class="nav" id="mainNav" style="display:none;">
    <div class="nav-item active" onclick="switchPage('pageDiag', this)">Âç±Èô∫Âà§ÂÆö</div>
    <div class="nav-item" onclick="switchPage('pageHazard', this)">„Éè„Ç∂„Éº„Éâ</div>
    <div class="nav-item" onclick="switchPage('pageDiary', this)">Êó•Ë®òÁôªÈå≤</div>
    <div class="nav-item" onclick="loadHistory(this)">Â±•Ê≠¥</div>
</div>

<script>
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec";
    let myChart;

    function showApp() { 
        document.getElementById('loginOverlay').style.display = 'none'; 
        document.getElementById('mainApp').style.display = 'block'; 
        document.getElementById('mainNav').style.display = 'flex';
        document.getElementById('logoutBtn').style.display = 'block'; // „É≠„Ç∞„Ç¢„Ç¶„ÉàË°®Á§∫
    }
    function logout() { localStorage.removeItem('campGuardUser'); location.reload(); }

    async function attemptLogin() {
        const uid = document.getElementById('uid').value.trim();
        const pwd = document.getElementById('pwd').value.trim();
        if(!uid || !pwd) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(`${gasUrl}?mode=login&uid=${encodeURIComponent(uid)}&pwd=${encodeURIComponent(pwd)}`);
            if (await res.text() === "success") { localStorage.setItem('campGuardUser', uid); showApp(); } else { alert("Â§±Êïó"); }
        } catch(e) { alert("„Ç®„É©„Éº"); }
        document.getElementById('loader').style.display = 'none';
    }

    if (localStorage.getItem('campGuardUser')) showApp();

    async function diagnose() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const loc = document.getElementById('loc').value;
            const res = await fetch(`${gasUrl}?mode=diagnose&place=${encodeURIComponent(loc)}`);
            const data = await res.json();
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('resLoc').innerText = data.locationName;
            document.getElementById('resScore').innerText = data.score;
            document.getElementById('resReason').innerText = `(${data.scoreReason})`;
            updateGauge(data.score);
            let html = `<div style="background:rgba(56, 189, 248, 0.1); padding:14px; border-radius:16px; margin:12px 0; font-weight:bold; border:1px solid rgba(56,189,248,0.3);">${data.alertTitle}</div>`;
            if(data.localInsights?.length > 0) {
                html += `<div class="tag">üö® ÂÖà‰∫∫„ÅÆÂ£∞</div>`;
                data.localInsights.forEach(i => { html += `<div class="insight-box local-info"><div>${i.content}</div></div>`; });
            }
            html += `<div class="tag">üõ°Ô∏è Êé®Â•®</div><div class="insight-box" style="background:rgba(255,255,255,0.05);">${data.checkList.map(item => `<div>‚úÖ ${item}</div>`).join('')}</div>`;
            document.getElementById('insightContainer').innerHTML = html;
            document.getElementById('resTimeline').innerHTML = data.timeline.map(t => `<div class="t-item"><div>${t.time}</div><img src="https://openweathermap.org/img/wn/${t.icon}.png" width="30"><div>${t.temp}‚ÑÉ</div></div>`).join('');
        } catch(e) { alert("Âà§ÂÆö„Ç®„É©„Éº"); }
        document.getElementById('loader').style.display = 'none';
    }

    async function loadHazardMap() {
        const area = document.getElementById('hArea').value;
        const date = document.getElementById('hDate').value;
        if(!date) return alert("ÈñãÂßãÊó•ÊôÇ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(`${gasUrl}?mode=areaHazard&area=${encodeURIComponent(area)}&date=${encodeURIComponent(date)}`);
            const data = await res.json();
            let html = "";
            data.forEach(item => {
                const color = item.score >= 70 ? '#ef4444' : (item.score >= 40 ? '#f59e0b' : '#10b981');
                html += `<div class="main-card" style="border-left:8px solid ${color}; text-align:left;">
                    <div style="display:flex; justify-content:space-between;"><b>${item.name}</b><b style="color:${color}">${item.score}ÁÇπ</b></div>
                    <div style="font-size:0.7rem; opacity:0.7;">${item.reason} | È¢®:${item.maxWind}m/s ÊúÄÂ∞è:${item.minTemp}‚ÑÉ</div>
                </div>`;
            });
            document.getElementById('hazardList').innerHTML = html || "„Éá„Éº„Çø„Å™„Åó";
        } catch(e) { alert("ÈÄö‰ø°„Ç®„É©„Éº"); }
        document.getElementById('loader').style.display = 'none';
    }

    function updateGauge(score) {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        const color = score >= 70 ? '#ef4444' : (score >= 40 ? '#f59e0b' : '#10b981');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [score, 100 - score], backgroundColor: [color, 'rgba(255,255,255,0.05)'], circumference: 180, rotation: 270, cutout: '90%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false, tooltip: false } } });
    }

    async function saveDiary() {
        const d = ["dDate","dPlace","dTopic","dContent"].map(id => document.getElementById(id).value);
        if(d.some(v => !v)) return alert("Êú™ÂÖ•Âäõ");
        document.getElementById('loader').style.display = 'flex';
        await fetch(`${gasUrl}?mode=postDiary&place=${encodeURIComponent(d[1])}&topic=${encodeURIComponent(d[2])}&content=${encodeURIComponent(d[3])}&campDate=${encodeURIComponent(d[0])}&uid=${encodeURIComponent(localStorage.getItem('campGuardUser'))}`, {mode: 'no-cors'});
        alert("ÁôªÈå≤ÂÆå‰∫Ü");
        switchPage('pageDiag', document.querySelectorAll('.nav-item')[0]);
        document.getElementById('loader').style.display = 'none';
    }

    async function loadHistory(el) {
        switchPage('pageHistory', el);
        const list = document.getElementById('historyList');
        list.innerHTML = "Ë™≠Ëæº‰∏≠...";
        const res = await fetch(`${gasUrl}?mode=getDiaries&uid=${encodeURIComponent(localStorage.getItem('campGuardUser'))}`);
        const data = await res.json();
        list.innerHTML = data.map(d => `<div class="main-card" style="text-align:left;"><div style="color:var(--accent); font-size:0.7rem;">${d.campDate}</div><b>${d.topic}</b><p>${d.content}</p></div>`).join('') || "„Å™„Åó";
    }

    function switchPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }
</script>
</body>
</html>
