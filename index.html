<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampGuard Pro - Expert</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card: rgba(30, 41, 59, 0.8);
            --accent: #38bdf8; --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --text: #f1f5f9;
        }
        body {
            font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--text);
            transition: background 1s ease; min-height: 100vh;
        }
        .container { width: 100%; max-width: 480px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        
        /* æ¤œç´¢ã¨ç¾åœ¨åœ° */
        .search-row { display: flex; gap: 8px; margin: 20px 0; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: var(--card); color: white; }
        .btn-gps { background: #475569; padding: 10px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ã‚¸ */
        .main-card { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; margin-bottom: 15px; }
        .chart-container { height: 180px; position: relative; }
        .score-display { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); }
        .score-num { font-size: 3.5rem; font-weight: 900; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆ3æ®µéšï¼‰ */
        .timeline { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .time-box { background: var(--card); padding: 10px; border-radius: 12px; text-align: center; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.05); }
        
        /* ã€é‡è¦ã€‘è£…å‚™ã‚¢ãƒ‰ãƒã‚¤ã‚¹ */
        .advice-card { background: linear-gradient(145deg, #1e293b, #0f172a); border-radius: 20px; padding: 20px; border-left: 5px solid var(--accent); margin-bottom: 15px; display: none; }
        .advice-title { font-weight: bold; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .gear-item { background: rgba(56, 189, 248, 0.1); padding: 8px 12px; border-radius: 6px; margin: 5px 0; font-size: 0.85rem; border: 1px border: 1px solid rgba(56, 189, 248, 0.2); }

        /* å‘¨è¾ºã‚¹ãƒãƒƒãƒˆæ¯”è¼ƒ */
        .nearby-card { background: var(--card); border-radius: 20px; padding: 15px; font-size: 0.8rem; display: none; }
        .nearby-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .loading-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay"><div>Analyzing Environment...</div></div>

<div class="container">
    <div class="header">
        <h2 style="margin:0; font-weight:900;">CampGuard <span style="color:var(--accent)">Expert</span></h2>
    </div>

    <div class="search-row">
        <input type="text" id="locInput" placeholder="ã‚­ãƒ£ãƒ³ãƒ—å ´åãƒ»åœ°å" value="å–œå¤šæ–¹å¸‚">
        <button class="btn-gps" onclick="useGPS()">ğŸ“</button>
        <button onclick="diagnose()" style="background:var(--accent); color:black; font-weight:bold; border:none; border-radius:8px; padding:0 20px;">è¨ºæ–­</button>
    </div>

    <div class="main-card">
        <div class="chart-container"><canvas id="gaugeChart"></canvas></div>
        <div class="score-display">
            <div id="scoreVal" class="score-num">--</div>
            <div id="locName" style="font-size:0.8rem; color:var(--accent)">Ready</div>
        </div>
    </div>

    <div class="timeline">
        <div class="time-box"><div>ä»Š</div><div id="tNow" style="font-weight:bold">--</div></div>
        <div class="time-box"><div>ä»Šå¤œ</div><div id="tNight" style="font-weight:bold">--</div></div>
        <div class="time-box"><div>æ˜æ—¥</div><div id="tNext" style="font-weight:bold">--</div></div>
    </div>

    <div id="adviceArea" class="advice-card">
        <div class="advice-title">ğŸ’ æ¨å¥¨è£…å‚™ & å¯¾ç­–</div>
        <div id="gearList"></div>
    </div>

    <div id="nearbyArea" class="nearby-card">
        <div style="font-weight:bold; margin-bottom:10px;">ğŸ“ å‘¨è¾ºã®çŠ¶æ³</div>
        <div id="nearbyList"></div>
    </div>
</div>

<script>
    let myChart;
    const gasUrl = "https://script.google.com/macros/s/AKfycbyqDTFt6HyyWfDLJJTkB2hQfSik9oJJfmIJBsRZ4U_kacbxYjlE2lB759s7scGMhaHx/exec";

    function initChart() {
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [1, 1, 1], backgroundColor: ['#1e293b','#1e293b','#1e293b'], borderWidth: 0, circumference: 180, rotation: 270 }] },
            options: { cutout: '85%', plugins: { legend: { display: false } } }
        });
    }

    async function useGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            document.getElementById('locInput').value = `${pos.coords.latitude},${pos.coords.longitude}`;
            diagnose();
        });
    }

    async function diagnose() {
        const loc = document.getElementById('locInput').value;
        document.getElementById('loader').style.display = 'flex';
        
        try {
            const res = await fetch(`${gasUrl}?place=${encodeURIComponent(loc)}`);
            const data = await res.json();
            
            // UIåæ˜ 
            document.getElementById('scoreVal').innerText = data.score;
            document.getElementById('locName').innerText = data.locationName;
            document.getElementById('tNow').innerText = data.windSpeed + "m";
            document.getElementById('tNight').innerText = data.forecast.night + "m";
            document.getElementById('tNext').innerText = data.forecast.tomorrow + "m";

            // ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤º
            const gearList = document.getElementById('gearList');
            gearList.innerHTML = data.gearAdvice.map(a => `<div class="gear-item">âš ï¸ ${a}</div>`).join('');
            document.getElementById('adviceArea').style.display = 'block';

            // å‘¨è¾ºæ¯”è¼ƒ
            const nearbyList = document.getElementById('nearbyList');
            nearbyList.innerHTML = data.nearby.map(n => `<div class="nearby-item"><span>${n.name}</span><b>Score: ${n.score}</b></div>`).join('');
            document.getElementById('nearbyArea').style.display = 'block';

            updateTheme(data.score);
        } catch (e) { alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        document.getElementById('loader').style.display = 'none';
    }

    function updateTheme(score) {
        const body = document.body;
        const colors = myChart.data.datasets[0].backgroundColor;
        colors.fill('#1e293b');
        if (score >= 70) { body.style.background = "#450a0a"; colors[2] = "#ef4444"; }
        else if (score >= 40) { body.style.background = "#1e293b"; colors[1] = "#f59e0b"; }
        else { body.style.background = "#064e3b"; colors[0] = "#10b981"; }
        myChart.update();
    }

    window.onload = initChart;
</script>
</body>
</html>
